<!DOCTYPE html>
<html>
<head>
</head> <script src="http://d3js.org/d3.v3.min.js"></script>
<body>
	<script type="text/javascript">

	// width and height
	var w = 800;
	var h = 500;

	var net = {boxes:[],wires:[]};
	var force = d3.layout.force()
					.nodes(net.boxes)
					.links(net.wires)
					.size([w,h])
					.linkDistance(60)
					.charge(-500)
					.start();
	// create svg element
	var svg = d3.select("body")
				.append("svg")
				.attr("width", w)
				.attr("height", h);
	// draw lines
	var edges = svg.selectAll("line")
					.data(net.wires)
					.enter()
					.append("line")
					.style("stroke","#777")
					.style("stroke-width",2);

	var nodes = svg.selectAll("circle")
					.data(net.boxes)
					.enter()
					.append("circle")
					.attr("r",20)
					.style("fill","#4a2")
					.call(force.drag);				
		
	// sound effect
	var snd = new Audio("button-30.wav"); // buffers automatically when created

	function box_index(box){
		for (var i=0; i < net.boxes.length; i++){
			if (net.boxes[i].name == box){return i;}
			};
		return -1;
	};

	function init_net(msg){
		// Original data
		var boxes =[ "box1", "box2", "box3", "box4" ];
		var	wires =[ 
			{source:0,target:1},
			{source:1,target:2},
			{source:2,target:3},
			{source:1,target:3},
			]
		
		for (var i=0; i<boxes.length; i++){
			net.boxes.push({"name":boxes[i]});
		};

		for (var i=0; i<wires.length; i++){
			net.wires.push(wires[i]);
		};

		// set force
		force.nodes(net.boxes);

		edges = svg.selectAll("line")
					.data(net.wires)
					.enter()
					.append("line")
					.style("stroke","#777")
					.style("stroke-width",2);

		nodes = svg.selectAll("circle")
					.data(net.boxes)
					.enter()
					.append("circle")
					.attr("r",20)
					.style("fill","#4a2")
					.call(force.drag);

		force.start();
			
		force.on("tick", function(){
			edges.attr("x1",function(d){return d.source.x;})
				.attr("y1", function(d){return d.source.y;})
				.attr("x2", function(d){return d.target.x;})
				.attr("y2", function(d){return d.target.y;});
			nodes.attr("cx",function(d){return d.x;})
				.attr( "cy",function(d){return d.y;});
		});
	};

	function boxing(msg){
		// msg = {type: add_box|del_box, name: box_name}
		var box = msg.name;
		if (msg.type == 'add_box'){
			net.boxes.push({"name":box});
		}
		else if (msg.type == 'del_box'){
			var i = box_index(box);
			if (i>=0){net.boxes.splice(i+1,1);}
			else {alert("There is no box name: "+box);}	
		}
		else { alert("Error: wrong message type: "+msg.type);};
		
		force.nodes(net.boxes);
		
		var nodes = svg.selectAll("circle")
						.data(net.boxes)
						.style("fill","green");
		nodes.enter()
			.append("circle")
			.attr("r",20)
			.style("fill","grey")
			.call(force.drag);

		nodes.exit().remove();

		var edges = svg.selectAll("line")
					.data(net.wires);

		force.on("tick", function(){
			edges.attr("x1",function(d){return d.source.x;})
				.attr("y1", function(d){return d.source.y;})
				.attr("x2", function(d){return d.target.x;})
				.attr("y2", function(d){return d.target.y;});
			nodes.attr("cx",function(d){return d.x;})
				.attr( "cy",function(d){return d.y;});
		});
		force.start();
	};	
	
	function wiring(msg){
		// msg = {type: add_wire, b1: box1, b2:box2}
		var b1_index = box_index(msg.b1);
		var b2_index = box_index(msg.b2);
		
		if (msg.type == 'add_wire'){
			if (b1_index>=0 & b2_index>=0){net.wires.push({"source":b1_index,"target":b2_index});}
			else {alert("ERROR: Box1 or/and Box2 does not exist");}
			
			
			force.nodes(net.boxes);
			var nodes = svg.selectAll("circle")
						.data(net.boxes);

			var edges = svg.selectAll("line")
					.data(net.wires)
					.style("stroke","#777");

			edges.exit().remove();
			
			edges.enter()
				.insert("line","circle")
				.style("stroke","#a22")
				.style("stroke-width",2);
				
			
			force.on("tick", function(){
				edges.attr("x1",function(d){return d.source.x;})
					.attr("y1", function(d){return d.source.y;})
					.attr("x2", function(d){return d.target.x;})
					.attr("y2", function(d){return d.target.y;});
				nodes.attr("cx",function(d){return d.x;})
					.attr( "cy",function(d){return d.y;});
			});
			force.start();
		}
		};
	
	
	// message handler
	var box_name = window.location.href.replace(/^(?:\/\/|[^\/]+)*\//, "");
	var ws = new WebSocket("ws://localhost:8080/websocket/" + box_name);
	ws.onopen = function() { ws.send("get_entire_net")};
	
	ws.onmessage = function (evt) { 
		var msg = JSON.parse(evt.data);
		snd.play();
		if (msg.type == "entire_net") { init_net(msg);}
		else if (msg.type == "add_box" || msg.type == "del_box") {boxing(msg);}
		else if (msg.type == "add_wire" || msg.type == "del_wire") {wiring(msg);}
		else {
			init_net(msg);
			//alert("ERROR: got wrong message: "+msg);
		}
		};

	</script>

</body>
</html>	
